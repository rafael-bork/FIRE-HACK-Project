import pandas as pd
import numpy as np
from scipy.stats import normaltest

# === 1. Ler o ficheiro ===
CSV_PATH = "PT-FireProg_v2.1_L2_p_meteo_crg.csv"
df = pd.read_csv(CSV_PATH, sep=";")

# === 2. Selecionar apenas variáveis numéricas ===
df_num = df.select_dtypes(include=[np.number])

# === 3. Calcular métricas básicas ===
total_rows = len(df_num)

summary = pd.DataFrame({
    "Validos": df_num.notna().sum(),
    "NaN_%": df_num.isna().sum() / total_rows * 100,
    "Zeros": (df_num == 0).sum(),
    "Negativos": (df_num < 0).sum()
})

# === 4. Calcular p-values do teste de normalidade ===
p_values = []
for col in df_num.columns:
    data = df_num[col].dropna()
    if len(data) > 7:  # normaltest requer pelo menos 8 observações
        try:
            stat, p = normaltest(data)
        except Exception:
            p = np.nan
    else:
        p = np.nan
    p_values.append(p)

summary["Normalidade_p"] = p_values

# === 5. Interpretar normalidade (opcional) ===
summary["Normal?"] = summary["Normalidade_p"].apply(
    lambda p: "Sim" if p > 0.05 else ("Não" if not np.isnan(p) else "N/A")
)

# === 6. Ordenar por percentagem de NaN ===
summary = summary.sort_values(by="NaN_%", ascending=False)

# === 7. Mostrar resultados ===
print("Resumo com NaNs, zeros, negativos, válidos e p-value de normalidade:")
print(summary.round(4))

# === 8. (Opcional) Guardar em CSV ===
summary.to_csv("nans_zeros_negativos_normalidade_summary.csv", sep=";", index=True)
print("\n✅ Guardado em 'nans_zeros_negativos_normalidade_summary.csv'")
