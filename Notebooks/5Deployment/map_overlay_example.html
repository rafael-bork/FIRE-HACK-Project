<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raster Overlay Example - GeoTIFF.js</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .color-scale {
            display: flex;
            height: 20px;
            width: 200px;
            border: 1px solid #ccc;
        }

        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .controls label {
            display: block;
            margin: 10px 0 5px 0;
            font-size: 12px;
            font-weight: bold;
        }

        .controls select, .controls input {
            width: 100%;
            padding: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Controls Panel -->
    <div class="controls">
        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Raster Overlay</h3>

        <label for="raster-select">Select Layer:</label>
        <select id="raster-select">
            <option value="none">None</option>
            <option value="slope">Slope</option>
            <option value="aspect">Aspect</option>
            <option value="elevation">Elevation</option>
            <option value="fuel_load">Fuel Load</option>
        </select>

        <label for="opacity-slider">Opacity:</label>
        <input type="range" id="opacity-slider" min="0" max="100" value="70">
        <span id="opacity-value">70%</span>
    </div>

    <!-- Legend -->
    <div class="legend" id="legend" style="display: none;">
        <h4 id="legend-title">Slope (%)</h4>
        <div class="color-scale" id="color-scale"></div>
        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-top: 5px;">
            <span id="min-value">0</span>
            <span id="max-value">100</span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- GeoTIFF.js -->
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotty@0.4.10/src/plotty.min.js"></script>

    <!-- Georaster -->
    <script src="https://unpkg.com/georaster@1.6.0/dist/georaster.browser.bundle.min.js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet@3.10.0/dist/georaster-layer-for-leaflet.browser.bundle.min.js"></script>

    <script>
        // Initialize map
        const map = L.map('map').setView([39.5, -8.0], 7);

        // Add base layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // Store current overlay layer
        let currentLayer = null;

        // Color ramps for different data types
        const colorRamps = {
            slope: {
                title: 'Slope (%)',
                colors: ['#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c', '#b10026'],
                min: 0,
                max: 50
            },
            aspect: {
                title: 'Aspect (degrees)',
                colors: ['#2166ac', '#4393c3', '#92c5de', '#d1e5f0', '#fddbc7', '#f4a582', '#d6604d', '#b2182b'],
                min: 0,
                max: 360
            },
            elevation: {
                title: 'Elevation (m)',
                colors: ['#f7fcf5', '#e5f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#41ab5d', '#238b45', '#005a32'],
                min: 0,
                max: 2000
            },
            fuel_load: {
                title: 'Fuel Load (kg/mÂ²)',
                colors: ['#fff7ec', '#fee8c8', '#fdd49e', '#fdbb84', '#fc8d59', '#ef6548', '#d7301f', '#990000'],
                min: 0,
                max: 5
            }
        };

        // Load and display GeoTIFF
        async function loadGeoTIFF(rasterName) {
            // Remove previous layer
            if (currentLayer) {
                map.removeLayer(currentLayer);
                currentLayer = null;
            }

            if (rasterName === 'none') {
                document.getElementById('legend').style.display = 'none';
                return;
            }

            try {
                // Fetch the GeoTIFF file
                const url = `../../Data/web_rasters/${rasterName}.tif`;
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();

                // Parse GeoTIFF
                const georaster = await parseGeoraster(arrayBuffer);

                // Get color ramp settings
                const settings = colorRamps[rasterName];

                // Create layer
                currentLayer = new GeoRasterLayer({
                    georaster: georaster,
                    opacity: parseFloat(document.getElementById('opacity-slider').value) / 100,
                    pixelValuesToColorFn: function(values) {
                        const value = values[0];

                        if (value === null || value === undefined || isNaN(value)) {
                            return null; // Transparent for no-data
                        }

                        // Normalize value to 0-1 range
                        const normalized = (value - settings.min) / (settings.max - settings.min);
                        const clamped = Math.max(0, Math.min(1, normalized));

                        // Get color from gradient
                        const colorIndex = Math.floor(clamped * (settings.colors.length - 1));
                        const color = settings.colors[colorIndex];

                        // Convert hex to RGB
                        const r = parseInt(color.slice(1, 3), 16);
                        const g = parseInt(color.slice(3, 5), 16);
                        const b = parseInt(color.slice(5, 7), 16);

                        return `rgba(${r}, ${g}, ${b}, 1)`;
                    },
                    resolution: 256
                });

                currentLayer.addTo(map);

                // Update legend
                updateLegend(rasterName);

            } catch (error) {
                console.error('Error loading GeoTIFF:', error);
                alert(`Error loading raster: ${error.message}\n\nMake sure the file exists at: ../../Data/web_rasters/${rasterName}.tif`);
            }
        }

        // Update legend
        function updateLegend(rasterName) {
            const settings = colorRamps[rasterName];

            document.getElementById('legend-title').textContent = settings.title;
            document.getElementById('min-value').textContent = settings.min;
            document.getElementById('max-value').textContent = settings.max;

            // Create color gradient
            const colorScale = document.getElementById('color-scale');
            colorScale.style.background = `linear-gradient(to right, ${settings.colors.join(', ')})`;

            document.getElementById('legend').style.display = 'block';
        }

        // Event listeners
        document.getElementById('raster-select').addEventListener('change', function(e) {
            loadGeoTIFF(e.target.value);
        });

        document.getElementById('opacity-slider').addEventListener('input', function(e) {
            const opacity = parseFloat(e.target.value) / 100;
            document.getElementById('opacity-value').textContent = e.target.value + '%';

            if (currentLayer) {
                currentLayer.setOpacity(opacity);
            }
        });

        // Click on map to get value
        map.on('click', async function(e) {
            if (!currentLayer) return;

            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            const rasterName = document.getElementById('raster-select').value;

            try {
                // Fetch value from backend API
                const response = await fetch(`http://localhost:5000/api/raster/${rasterName}/value?lat=${lat}&lon=${lng}`);
                const data = await response.json();

                if (data.success && data.value !== null) {
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(`<b>${colorRamps[rasterName].title}</b><br>Value: ${data.value.toFixed(2)}`)
                        .openOn(map);
                }
            } catch (error) {
                console.error('Error fetching raster value:', error);
            }
        });
    </script>
</body>
</html>
